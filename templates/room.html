<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title id="head_title"></title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.1/css/drawer.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/css/tether.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js" integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/iScroll/5.1.3/iscroll.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.1/js/drawer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.2.2/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js"></script>

    {% load staticfiles %}
    <link rel="stylesheet" href="{% static "css/font-awesome.min.css" %}">
    <script src="{% static "js/reconnecting-websocket.min.js" %}" type="text/javascript"></script>
    <script src="{% static "js/diff_match_patch.min.js" %}" type="text/javascript"></script>
    <script src="{% static "js/java-hashcode-conv.js" %}" type="text/javascript"></script>

  </head>
  <style>
  .CodeMirror {
    height: auto;
  }
  .halves {
    width:50%;
    display:inline-block;
    vertical-align: top;
    border-color: #eee;
    border-width: thin;
    border-style:solid;
  }
  </style>

      <!-- connected user couting -->
      <script>
        $(function () {
          // Correctly decide between ws:// and wss://
          var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
          var ws_path = ws_scheme + '://' + window.location.host + "/room/";
          console.log("Connecting to " + ws_path);
          var socket = new ReconnectingWebSocket(ws_path);  // Create websocket

          socket.onmessage = function (message) {
            // Decode the JSON
            console.log("Got websocket message " + message.data);
            var data = JSON.parse(message.data);

            // Handle errors
            if (data.error) {
              alert(data.error);
              return;
            }
            // Handle joining
            if (data.join) {
              console.log("Joining room " + data.join);
              // Handle leaving
              } else if (data.leave) {
                console.log("Leaving room " + data.leave);
                data.leave.remove();
                // Handle getting a message
              } else if (data.msg_type != 0) {
                // msg types are defined in manage_room/setting.py
                switch (data.msg_type) {
                  case 4:
                    // User joined room
                    console.log("some user joined room");
                    break;
                  case 5:
                    // User left room
                    console.log("some user left room");
                    break;
                  default:
                    console.log("Unsupported message type!");
                    return;
                }
              } else {
                console.log("Cannot handle message!");
              }
            };

            // Helpful debugging
            socket.onopen = function () {
              console.log("connected websocket");

              room_label = window.location.pathname;
              room_label = room_label.substring(1, room_label.length-1);

              socket.send(JSON.stringify({
                  "command": "join",
                  "room": room_label
                }));
            };

            socket.onclose = function () {
              console.log("disconnected websocket");

              room_label = window.location.pathname;
              room_label = room_label.substring(1, room_label.length-1);

              socket.send(JSON.stringify({
                  "command": "leave",
                  "room": room_label
                }));
            };
        });
      </script>

  <body class="drawer drawer--left" style="background-color:#eee">
    <!-- Slide delete modal -->
    <div class="modal fade" id="delete_slide_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Are you sure to delete this slide?</h4>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal" onclick="delSlide()">Delete slide</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide rename modal -->
    <div class="modal fade" id="rename_slide_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <div class="input-group">
              <input id="slide_name_input" type="text" class="form-control form-control-lg" placeholder="unnamed slide">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="renameSlide()">Save</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Room rename modal -->
    <div class="modal fade" id="rename_room_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <div class="input-group">
              <input id="room_name_input" type="text" class="form-control form-control-lg">
            </div>
          </div>
          <div class="modal-footer">
            <!--<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="renameRoom()">Save</button>-->
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="rename_title_room">Save</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-light bg-faded" style="background-color:#151515; font-size:1.5em;">
      <a class="btn drawer-toggle">
        <i class="fa fa-bars" aria-hidden="true" style="color:white"></i>
      </a>

      <!-- Navbar: Title -->
      <h3 id="room_title" class="navbar-text" style="color:white">{{ title }}</h3>
      <i class="fa fa-pencil" style="display:inline-block; cursor:pointer; color:white;" aria-hidden="true" data-toggle="modal" data-target="#rename_room_modal"></i>
      <a href="#" style="padding-left:20px;"><i class="fa fa-link" aria-hidden="true" style="color:#7b7b7b"></i></a>
      <a href="#"><i class="fa fa-download" aria-hidden="true" style="color:#7b7b7b"></i></a>

      <!-- Navbar: People count -->
      <h3 class="navbar-text float-xs-right" style="color:#1e2ea5">
        <i class="fa fa-user-plus" aria-hidden="true"></i>
        <div id="user_count" style="float:right; margin-left:10px;">34</div>
      </h3>

    </nav>

    <!-- Drawer -->
    <nav class="drawer-nav" role="navigation" style="z-index:5">

      <!-- Drawer: Slide list -->
      <ul id="slide_list" class="drawer-menu list-group">
        <!-- Drawer: Slide list: Title -->
        <li class="list-group-item"><h4 class="list-group-item-heading">Contents</h4></li>
        <!-- Drawer: Slide list: Contents -->
      </ul>

      <!-- Drawer: "Add" button -->
      <button class="btn btn-secondary btn-block" style="border-style:none; padding:1em;" onclick="newSlide()"><i class="fa fa-plus" aria-hidden="true"></i></button>
    </nav>

    <!-- Contents -->
    <div class="container-fluid" style="z-index:4">

      <!-- Poll prompt(to be appended here when prompted) -->
      <div id="polls-wrapper" class="row" style="padding:0px 50px">
      </div>

      <!-- Shown Contents (without poll) -->
      <div id="contents-wrapper" class="row">

        <!-- Left Div -->
        <div class="col-md-8">

          <!-- Left Div: Slide title -->
          <div class="card" style="margin-top: 1em">
            <h4 class="card-title" style="margin-top:0.5em; margin-left:0.5em;">
              <span id="markdown_title">(empty)</span>
              <i class="fa fa-pencil" style="display:inline-block; cursor:pointer;" aria-hidden="true" data-toggle="modal" data-target="#rename_slide_modal"></i>
            <i class="fa fa-trash" aria-hidden="true" style="cursor:pointer; float:right; margin-right:0.5em;" data-toggle="modal" data-target="#delete_slide_modal"></i>
            </h4>

            <!-- Left Div: Slide title: delete button -->
          </div>

          <!-- Left Div: markdown & rendered output -->
          <div style="margin-top:1em; background-color:#eee">
            <div class="halves"><textarea id="code"></textarea>
            </div><div class="halves" id="out" style="padding:1em; background-color:#fff"></div>
          </div>

        </div>

        <!-- Right Div -->
        <div class="col-md-4">

          <!-- Right Div: Notice -->
          <div id="notice_card" class="card" style="margin-top:1em;">
            <div class="card-block" style="padding-bottom:10px;">

              <!-- Right Div: Notice: Notice title -->
              <h4 class="card-title"><i class="fa fa-podcast" aria-hidden="true"></i> Notice</h4>

              <!-- Right Div: Noice: Only show 1 notice -->
              <div id="shown-notice">
              </div>

              <!-- Hidden notice lists -->
              <div id="hidden-notice">
              </div>

              <!-- Toggle notice button -->
              <a onclick="toggleNotice();" class="card-text btn btn-sm btn-block"><i id="notice-toggler" class="fa fa-sort-asc" aria-hidden="true"></i></a>

            </div>
          </div>

          <!-- Chat -->
          <div class="card" style="margin-top: 1em">

            <!-- Chat title -->
            <div class="card-block" style="border-bottom:1px solid rgba(0,0,0,.125);">
              <h4 class="card-title" style="margin-bottom:0;"><i class="fa fa-comments-o" aria-hidden="true"></i> Q&A</h4>
            </div>

            <!-- Scrollable -->
            <div id="chat_list_scroll" class="list-group list-group-flush" style="overflow-y: scroll;">

              <!-- Recieved chats -->
              <div id="chat_list_items" class="list-group-item" style="border-style: none;">
              </div>
            </div>

            <!-- "New messages" button(only shown when new message came) -->
            <div id="chat_scroll_button" style="position:absolute; height:3em; text-align:center; bottom:2em; left:0px; right:0px; background-color:rgba(0, 116, 217, 0.8); padding-top:0.5em; color:#ffffff; visibility:hidden; cursor:pointer;" onclick="scrollDownToLastest()">
              New messages
            </div>

            <!-- Reply Form -->
            <form id="chat_form" method="post" action="">
              <div class="input-group" style="z-index:1">
                <input id="chat_input" type="text" class="form-control" placeholder="Type @help for syntax...">
                <span class="input-group-btn">
                  <button class="btn btn-secondary" id="send-btn" type="submit">Send</button>
                </span>
              </div>
            </form>

          </div>
        </div>
      </div>
    </div>

    <!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js" integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/iScroll/5.1.3/iscroll.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.1/js/drawer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.2.2/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    -->

   <script>
    // highlight.js init
    hljs.initHighlightingOnLoad();

    // markdownit init
    var md = markdownit({
      html: true,
      breaks: false,
      highlight: function(str, lang){
        // add line numbers for result
        var line_numbers = str.split('\n').length - 1;
        if(str[str.length-1] !== '\n') line_numbers += 1;
        var ret_lines = '';
        for(i=1; i<=line_numbers; i++) {
          ret_lines += '<p style="text-align:right; margin-bottom:0;">' + i + '</p>';
        }
        if(lang && hljs.getLanguage(lang)){
          try {
            // Return string **has** to be a one-liner
            return '<div><div style="width:2.5em; float:left; padding:0.5em 0.5em 0.5em 0; background-color: #f7f7f7; border-right-color: #bdbdbd;border-right-width: 1px; border-right-style: solid;">' + ret_lines + '</div><div style="margin-left:2.5em; padding:0.5em 0.5em 0.5em 1em; background-color:#fdf6e3;">' + hljs.highlight(lang, str).value + '</div></div>';
          } catch(_){}
        }
        return '<div><div style="width:2.5em; float:left; padding:0.5em 0.5em 0.5em 0; background-color: #f7f7f7; border-right-color: #bdbdbd;border-right-width: 1px; border-right-style: solid;">' + ret_lines + '</div><div style="margin-left:2.5em; padding:0.5em 0.5em 0.5em 1em; background-color:#fdf6e3;">' + str + '</div></div>';
      },
    });

    // codemirror init
    var editor = new SimpleMDE({
      element: document.getElementById("code"),
      autofocus: true,
      spellChecker: true,
      forceSync: true,
      lineNumbers: true,
      toolbarTips: false,
      promptURLs: false,

      insertTexts: {
        image: ["![enter image description here](http://", ")"],
        link: ["[enter link description here](http://", ")"],
        horizontalRule: ["", "\n\n-----\n\n"],
        table: ["", "\n\n| Column 1 | Column 2 | Column 3 |\n| -------- | -------- | -------- |\n| Text     | Text      | Text     |\n\n"],
      },
      toolbar: ["bold", "italic", "strikethrough", "heading", "|",
      "code", "quote", "horizontal-rule", "|",
      "ordered-list", "unordered-list", "table", "|",
      "link", "image", "|",
      "guide"],
    });

    editor.codemirror.on("change", function(e) {
      var out = document.getElementById("out");
      // TODO!important: change e.getValue() (remove # sth)
      out.innerHTML = md.render(e.getValue());
      $('blockquote').addClass('blockquote');

      var slide_title = '(empty)';
      var slide_title_color = '#D8D8D8';

      // if there is something inside text, change slide title
      if($('h1').length !== 0) {
        var user_defined_title = $('h1')[0].textContent;
        //YJuser_defined_title = user_defined_title.match(/^[\s\S]{1,30}/g)[0];
        if (user_defined_title.length !== 0) {
          slide_title = user_defined_title;
          slide_title_color = 'black';

          // remove h1 at Left Div: rendered output
          $('h1').contents()[0].remove();

          // Changes title inside drawer: not dealt here!
          // $('#slide_' + currSlideIndex()).text(slide_title);

          // Changes Left Div: Slide title
          var title = $('h4#markdown_title.card-title');
          title.text(slide_title);
          title.css({'color': slide_title_color});
        }
      }
    });

    // diff_match_patch init
    var dmp = diff_match_patch();

    $(document).ready(function() {
      // drawer init
      $('.drawer').drawer({
        class: {
          nav: 'drawer-nav',
          toggle: 'drawer-toggle'
        },
        iscroll: {
          mouseWheel: true,
          preventDefault: false
        },
        showOverlay: true
      });

      // sortable init
      $('#slide_list').sortable({
        update: function(event, ui) {
          var curr_slide = ui.item;
          var prev_slide = ui.item.prev();
          var next_slide = ui.item.next();

          var curr_slide_idx = parseInt(curr_slide.attr('id').split('_')[1]);
          var prev_slide_idx = 0;
          var next_slide_idx = 0;

          if(prev_slide.length === 1 && typeof prev_slide.attr('id') != 'undefined' && prev_slide.attr('id').substring(0,6) === 'slide_') {
            prev_slide_idx = parseInt(prev_slide.attr('id').split('_')[1]);
          }
          if(next_slide.length === 1 && typeof next_slide.attr('id') != 'undefined' && next_slide.attr('id').substring(0,6) === 'slide_') {
            next_slide_idx = parseInt(next_slide.attr('id').split('_')[1]);
          }

          // debug: send server curr,prev,next slide idx
          console.log(curr_slide_idx + ' ' + prev_slide_idx + ' ' + next_slide_idx);
        }
      });

      // rename slide modal init
      $('#rename_slide_modal').on('show.bs.modal', function(e) {
        $('#slide_name_input').val($('#markdown_title').text());
      });

      // rename room modal init
      $('#rename_room_modal').on('show.bs.modal', function(e) {
        $('#room_name_input').val($('#room_title').text());
      });
      $('#room_name_input').attr('placeholder', window.location.pathname.replace(/^\/+|\/+$/g, '')); // default value

      // debug: get lists of slides and data of each slide
      // note: how to find out slides' titles?
      var is_empty_slide = true;
      var first_slide_idx = 0;

      if(is_empty_slide) {
        newSlide();
      }
      else {
        // debug: find out from server's response
        first_slide_idx = 32;

        clickSlide(first_slide_idx);
      }

      chatListResize();
    });

    // notice show/hide
    function toggleNotice() {
      $('#hidden-notice').slideToggle({duration:200, step:chatListResize});

      if($('#notice-toggler').hasClass('fa-sort-desc')) {
        $('#notice-toggler').removeClass('fa-sort-desc');
        $('#notice-toggler').addClass('fa-sort-asc');
      }
      else if($('#notice-toggler').hasClass('fa-sort-asc')) {
        $('#notice-toggler').removeClass('fa-sort-asc');
        $('#notice-toggler').addClass('fa-sort-desc');
      }
      chatListResize();
    }

    function chatListResize() {
      var viewport_height = $(window).height();
      var start_height = $('#notice_card').height() + $('#notice_card').offset().top;
      var chat_list_height = viewport_height - start_height - 140;
      if(chat_list_height < 100) {
        chat_list_height = 100;
      }
      $('#chat_list_scroll').height(chat_list_height);
    }

    function startPoll(q_str, a_strs) {
      // debug
      q_str = "Q. How does this get toggled? Let's make this question much longer!";
      a_strs = ['Lorem ipsum dolor sit amet', 'consectetur adipiscing', 'elit', 'sed do eiusmod tempor incididunt ut labore et'];

      $('#contents-wrapper').css('visibility', 'hidden');
      var a_strs_str = '<h1 id="polls-question" class="display-4" align="center" style="margin: 50px auto; display: block; max-width: 1000px; text-align: center;">' + q_str + '</h1>'
      for(var i=0; i<a_strs.length; i+=1) {
        a_strs_str += '<button type="button" class="btn btn-secondary btn-lg btn-block" onclick="endPoll(' + i.toString() + ')">' + a_strs[i] + '</button>';
      }
      $('#polls-wrapper').append(a_strs_str);
    }

    function endPoll(ret_idx) {
      $('#polls-wrapper').empty();
      $('#contents-wrapper').css('visibility', 'visible');

      // debug: do something with ret_idx
      console.log('endPoll');
      console.log(ret_idx);
    }

    var curr_slide_idx = 0;
    function currSlideIndex(idx) {
      if(typeof idx != 'undefined') {
        curr_slide_idx = idx;
      }
      return curr_slide_idx;
    }

    function clickSlide(idx) {
      if(idx === currSlideIndex()) {
        return;
      }

      // debug: do something with idx and get data
      console.log('clickSlide');
      console.log(idx);
      var data = '# this is title with idx ' + idx.toString() + '\n## and this is content!\n### this too!';
      getSlideText(data);

      var preclicked_slide = $('#slide_' + currSlideIndex().toString());
      if(preclicked_slide.length !== 0) {
        preclicked_slide.removeClass('active');
      }
      currSlideIndex(idx);
      $('#slide_' + idx.toString()).addClass('active');

      $('.drawer').drawer('close');
    }

    var slide_text = '';
    function getSlideText(str) {
      if(typeof str != 'undefined') {
        slide_text = str;
        editor.value(str);
      }
      return slide_text;
    }

    function newSlide() {
      // debug: get new_idx from server
      var new_idx = 10;

      $('#slide_list').append('<li id="slide_' + new_idx.toString() + '" class="list-group-item drawer-menu-item" onclick="clickSlide(' + new_idx.toString() + ')">unnamed slide</li>');
      clickSlide(new_idx);
    }

    // this function only deal with **DRAWER & TITLE**
    function renameSlide(idx, name) {
      // called from modal
      if(typeof idx == 'undefined') {
        var idx = currSlideIndex();
        var name = $('#slide_name_input').val();
        if(!name) name = 'unnamed slide'; // default value
      }

      $('#slide_' + idx).text(name);
      if(idx === currSlideIndex()) {
        $('#markdown_title').text(name);
      }
    }

    function renameRoom(name) {
      // called from modal
      //name = document.getElementById("room_name_input").value;

      if(typeof name == 'undefined') {
        var name = $('#room_name_input').val();
        if(!name) name = window.location.pathname.replace(/^\/+|\/+$/g, ''); // default value
      }
      $('#room_title').text(name);
    }

    // this function only deal with **MDE**
    function changeSlide(idx, patch, remote_pre_hash, remote_curr_hash) {
      if(idx === currSlideIndex()) {
        var local_pre_text = getSlideText();
        var local_pre_hash = javaHash.hash(local_pre_text);

        // Case 1: No update
        if(local_pre_hash === remote_curr_hash) return;

        // Case 2: Normal update
        else if(local_pre_hash === remote_pre_hash) {
          var patches = dmp.patch_fromText(patch);
          var local_curr_text = dmp.patch_apply(patches, pre_text);
          getSlideText(local_curr_text);
        }

        // Case 3: Late update
        else {
          // debug: send local_pre_hash
          // this will call changeSlide again
        }
      }
    }

    function delSlide(idx) {
      // called from modal
      if(typeof idx == 'undefined') {
        idx = currSlideIndex();
      }

      // debug: remove idx from server
      console.log('deleted ' + idx);

      var curr_slide = $('#slide_' + idx);
      if(idx === currSlideIndex()) {
        // No more slides
        if($('li.drawer-menu-item').length === 1) {
          newSlide();
        }

        var next_slide = curr_slide.next();
        if(next_slide.length === 0) {
          next_slide = curr_slide.prev();
        }
        clickSlide(parseInt(next_slide.attr('id').split('_')[1]));
      }
      curr_slide.remove();
    }

    function changeSlideOrder(idx, next) {
      $('#slide_' + idx).detach().insertAfter('#slide_' + next);
    }

    $(window).resize(function() {
      chatListResize();
    });

    var valid_syntax = {
      help: "@help",
      notice: "@notice [<args>]",
      poll: "@poll [-t <\"title\">] <\"options\", ...>",
    };

    var valid_syntax_regex_pattern = [
      /^(\s)*@help\s*$/g,
      /^(\s)*@notice\s+.*$/g,
      /^(\s)*@poll\s+(-t\s*\"[^\"\']*\")?.*$/g,
    ];

    var help_regex = [
      /@/g, /@h/g, /@he/g,
      /@hel/g, /@help/g,
      /^(\s)*@help\s*$/g,
    ];

    var notice_regex = [
      /@/g, /@n/g, /@no/g,
      /@not/g, /@noti/g, /@notic/g,
      /@notice/g, /^(\s)*@notice\s+.*$/g,
    ];

    function validate_notice_syntax(command, matches) {
      var len = command.length,
          upper_bound = 7, // length of '@notice'
          is_valid = false,
          text = "@notice ",
          notice = "";

      if(len <= upper_bound) {
        // user is still typing the command;
        // check for partial syntax.
        is_valid = !!command.match(notice_regex[len-1]);
      } else {
        // check for full syntax
        is_valid = !!command.match(notice_regex[upper_bound]);
        // to retrieve only the notice message:
        // command.replace(/^(@notice\s*)/g, "");
        notice = command.replace(/^(@notice\s*)/g, "");
        text += notice;
      }

      if(is_valid === true) {
        matches = matches.concat([{label: valid_syntax.notice,
                                   value: text}]);
      } return matches;
    }

    function validate_help_syntax(command, matches) {
      var len = command.length,
          upper_bound = 5, // length of '@help'
          is_valid = false,
          text = "@help";

      if(len <= upper_bound) {
        // user is still typing the command;
        // check for partial syntax.
        is_valid = !!command.match(help_regex[len-1]);
      } else {
        // check for full systax
        is_valid = !!command.match(help_regex[upper_bound]);
      }
      if(is_valid === true) {
        matches = matches.concat([{label: valid_syntax.help,
                                   value: text}]);
      }
      return matches;
    }
    var poll_regex = [
      /^@$/g, /^@p$/g, /^@po$/g,
      /^@pol$/g, /^@poll$/g,
      /^@poll\s$/g,
    ];
    var poll_opt_regex = [
      /^-t\s*(?![^\"\'])/g,
      /^-(?![^t])/g,
    ];
    function validate_poll_syntax(command, matches) {
      var len = 0,
          upper_bound = 6,          // length of '@poll '
          is_valid = false,
          title_given = false,
          text = "@poll ",
          title = null,
          quotation_choice = "\"",  // either ' || "
          options = [];

      // remove leading white spaces
      command = command.replace(/^\s*/g, "");
      len = command.length;

      if(len <= upper_bound) {
        // user is still typing the command;
        // valid commands include: @, @p, @po, @pol, @poll
        if(!!command.match(poll_regex[len-1]))
          return matches = matches.concat([{label: valid_syntax.poll, value: text}]);
        else
          return matches;
      } else {
        if(!!!command.match(/^@poll\s+(?![^-\'\"])/g)) {
          // command doesn't start with '@poll '
          // or the first character after '@poll ' is invalid
          return matches;
        }
        // command starts with '@poll '
        // remove '@poll ' from the command
        command = command.replace(/^@poll\s+/g, "");
        if(command.length === 0) {
          // input command is '@poll '
          matches = matches.concat([{label: valid_syntax.poll, value: text}]);
          return matches;
        } else {
          command = command.trim();
        }

        if(!!command.match(/^-(?=[^t])/g)) {
          // check for invalid option
          return matches;
        }
        for(var i=0; i<poll_opt_regex.length; i+=1) {
          // title option is given before "","",...
          // if title given, sets title_given to true
          // console.log("[debug] checking for early title option");

          if(!!command.match(poll_opt_regex[i])) {
            title_given = true;
            command = command.replace(poll_opt_regex[i], "");
            text += "-t ";
            if(command.length === 0) {
              // input command is '@poll -t'
              text += (quotation_choice+quotation_choice);
              matches = matches.concat([{label: valid_syntax.poll, value: text}]);
              return matches;
            } else break;
          }
        }

        // console.log("[debug] checking for quotation choice");
        if(command[0] !== '"' && command[0] !== "'") {
          return matches;
        } else {
          quotation_choice = command[0];
        }

        if (title_given === true) {
          // console.log("[debug] retrieving early title");

          var finished = false;
          for(var i=1; i<command.length; i+=1) {
            if(command[i] === quotation_choice && command[i-1] !== "\\") {
              // user has finished typing title
              title = command.substring(1, i);
              title = title.trim();
              command = command.substring(i+1);
              finished = true; break;
            }
          }
          if(command.length === 0) {
            // user has given only the title
            text += quotation_choice + title + quotation_choice + " ";
            matches = matches.concat([{label: valid_syntax.poll, value: text}]);
            return matches;
          } else if(finished === false) {
            // user is in the middle of typing the title
            // delete the leading quotation mark and trim the white spaces
            command = command.substring(1);
            command = command.trim();
            text += quotation_choice+ command + quotation_choice + " ";
            matches = matches.concat([{label: valid_syntax.poll, value: text}]);
            return matches;
          } else if(finished === true) {
            // user has given the title, and there is more to come...
            text += quotation_choice + title + quotation_choice + " ";
          }
        } // end of if (title_given === true)

        // remove leading white spaces
        command = command.replace(/^\s*/g, "");
        if(command[0] !== quotation_choice)
          return matches;

        var option = "", finished = false;
        do {
          option = "", finished = false;
          for(var i=1; i<command.length; i+=1) {
            if(command[i] === quotation_choice && command[i-1] !== "\\") {
              // user has finished typing title
              option = command.substring(1, i);
              option = option.trim();
              if(option.length !== 0) options.push(option);
              command = command.substring(i+1);
              finished = true; break;
            }
          }
          if(command.length === 0) {
            // this option marks the end of user input
            for(var i=0; i<options.length; i+=1) {
              text += quotation_choice + options[i] + quotation_choice;
              if(i !== options.length-1) text += ', ';
              else if (i !== 0) text += ' ';
            }
            matches = matches.concat([{label: valid_syntax.poll, value: text}]);
            return matches;
          } else if(finished === false) {
            // user is in the middle of typing the option
            // delete the leading quotation mark and trim the white spaces
            command = command.substring(1);
            command = command.trim();
            options.push(command);
            for(var i=0; i<options.length; i+=1) {
              text += quotation_choice + options[i] + quotation_choice;
              if(i !== options.length-1) text += ', ';
            }
            matches = matches.concat([{label: valid_syntax.poll, value: text}]);
            return matches;
          } else if(finished === true) {
            // user has given the option, and there is more to come...
            command = command.replace(/^\s*/g, "");
            if(command[0] === ',') {
              command = command.replace(/^,\s*/g, "");
              if(command.length !== 0) {
                if(command[0] !== quotation_choice)
                  return matches;
              } else {
                for(var i=0; i<options.length; i+=1) {
                  text += quotation_choice + options[i] + quotation_choice;
                  text += ', ';
                } text += quotation_choice + quotation_choice;
                matches = matches.concat([{label: valid_syntax.poll, value: text}]);
                return matches;
              }
            } else if (title_given === false && command[0] === '-') {
              break;
            } else {
              return matches;
            }
          }
        } while(true);

        // if you are here, options are taken care of,
        // and user has not given the title option yet.
        // command should start with "-"
        if(!!command.match(/^-(?=[^t])/g)) {
          // check for invalid option
          return matches;
        }
        title = "";
        for(var i=0; i<poll_opt_regex.length; i+=1) {
          // title option is given after "","",...

          if(!!command.match(poll_opt_regex[i])) {
            command = command.replace(poll_opt_regex[i], "");
            text += "-t ";
            if(command.length === 0) {
              // input command is '@poll -t'
              text += (quotation_choice+quotation_choice+' ');
              for(var i=0; i<options.length; i+=1) {
                text += quotation_choice + options[i] + quotation_choice;
                if(i !== options.length-1) text += ', ';
              }
              matches = matches.concat([{label: valid_syntax.poll, value: text}]);
              return matches;
            } else break;
          }
        }
        if(command[0] !== quotation_choice)
          return matches;

        var finished = false;
        for(var i=1; i<command.length; i+=1) {
          if(command[i] === quotation_choice && command[i-1] !== "\\") {
            // user has finished typing title
            title = command.substring(1, i);
            title = title.trim();
            command = command.substring(i+1);
            finished = true; break;
          }
        }
        if(command.length === 0) {
          // user has given only the title
          text += quotation_choice + title + quotation_choice + " ";
        } else if(finished === false) {
          // user is in the middle of typing the title
          // delete the leading quotation mark and trim the white spaces
          command = command.substring(1);
          command = command.trim();
          text += quotation_choice+ command + quotation_choice + " ";
          for(var i=0; i<options.length; i+=1) {
            text += quotation_choice + options[i] + quotation_choice;
            if(i !== options.length-1) text += ', ';
          }
          matches = matches.concat([{label: valid_syntax.poll, value: text}]);
          return matches;
        } else if(finished === true) {
          // user has given the title, and there is more to come...
          text += quotation_choice + title + quotation_choice + " ";
        }
        // title and options all taken care of
        // there should be no remaining characters in command
        if(command.length !== 0)
          return matches;
      } // if(len <= upper_bound) else
      // for debugging: print title, options
      // console.log('title == ', title);
      // console.log('options == ', options);
      for(var i=0; i<options.length; i+=1) {
        text += quotation_choice + options[i] + quotation_choice;
        if(i !== options.length-1) text += ', ';
      }
      matches = matches.concat([{label: valid_syntax.poll, value: text}]);
      return matches;
    }

    $('#chat_form').submit(function (e) {
      // remove the leading white spaces
      var comment = $("#chat_input").val().replace(/^\s*/g, "");
      $('#chat_input').val('');
      e.preventDefault();
      console.log(comment);
      // debug: check send comment (whether its syntax is correct)
      // check syntax here
      // -> if correct, print the comment on console
      // -> if incorrect, print help message on console
      // var is_valid = false;
      // for(var i=0; i<valid_syntax_regex_pattern.length; i+=1) {
      //   is_valid = !!comment.match(valid_syntax_regex_pattern[i]);
      //   if(is_valid === true) {
      //     break;
      //   }
      // }
      // if(is_valid === true) {
      //   console.log(comment);
      // } else {
      //   comment = "'" + comment + "'";
      //   console.log(comment, "is not a valid command. See '@help'.");
      // }
    });

    $('#chat_input').autocomplete({
      position: {my: "left bottom", at: "left top"},
      source: function(request, response) {
        // debug: use regular expressions
        //console.log(request.term);

        // debug: return with list of dict
        // remove the leading white spaces
        var command = request.term.replace(/^\s*/g, ""),
            matches = [];
        matches = validate_help_syntax(command, matches);
        matches = validate_notice_syntax(command, matches);
        matches = validate_poll_syntax(command, matches);

        response(matches);
      },
      delay: 0,
    });

    var to_be_scrolled_position = 0;
    function toBeScrolledPosition(pos) {
      if(typeof pos != 'undefined') {
        to_be_scrolled_position = pos;
      }
      return to_be_scrolled_position;
    }

    function newChat(obj) {
      // debug: get with websocket. currently newChat(1) will add new chat, newChat(0) will add reply to hash_value
      //obj = {hash_value: 'this_is_hash_val', time: '2013.01.05. 13:32', description: 'chat description. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.', is_reply: obj===0};
      console.log(obj);

      var is_end_of_scroll = $('#chat_list_scroll').scrollTop() === $('#chat_list_scroll')[0].scrollHeight - $('#chat_list_scroll').height();
      var appended_elem = 0;
      if(obj.is_reply) {
        appended_elem = $('\
                  <div style="float: left; width: 30px; margin-top: 10px;"><i class="fa fa-reply" aria-hidden="true"></i></div>\
                  <div class="card" style="margin-left:30px;">\
                    <div class="card-block">\
                      <p class="card-text">' + obj.description + '</p>\
                    </div>\
                  </div>');
        $('#chat_list_items').find('#chat_' + obj.hash_value).append(appended_elem);
      }
      else {
        appended_elem = $('\
                <div id="chat_' + obj.hash_value + '">\
                  <div class="card">\
                    <div class="card-header" style="padding-left: .5rem;">\
                      <div style="float:left; margin-right: 10px;"><i class="fa fa-commenting-o" aria-hidden="true"></i> ' + obj.hash_value + '</div> <div style="margin:0;font-size:.5em;" align="right">' + obj.time + '</div>\
                    </div>\
                    <div class="card-block">\
                      <p class="card-text">' + obj.description + '</p>\
                    </div>\
                  </div>');
        $('#chat_list_items').append(appended_elem);
      }
      if(is_end_of_scroll) {
        $('#chat_list_scroll').animate({scrollTop: appended_elem.position().top}, 'slow');
      }
      else {
        if($('#chat_scroll_button').css('visibility') == 'hidden') {
          toBeScrolledPosition(appended_elem.position().top);
          $('#chat_scroll_button').css('visibility', 'visible');
        }
      }
    }

    function newPoll(obj) {
      // debug
      obj = {hash_value: 'this_is_hash_val', time: '2013.01.05. 13:32', question: 'poll description',
        answers: ['answer 1', 'answer 2', 'answer 3 - which is very long indeed!', 'ans4']};

      var is_end_of_scroll = $('#chat_list_scroll').scrollTop() === $('#chat_list_scroll')[0].scrollHeight - $('#chat_list_scroll').height();

      var ctx = $('<canvas id="poll_' + obj.hash_value + '" width="400" height="400"></canvas>');
      $('#chat_list_items').append(ctx);
      var pollChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: obj.answers,
          datasets: [{
            label: '',
            data: [13, 43, 92, 13],//data: Array.apply(null, {length: obj.answers.length}).map(function() {return 0;}),
          }],
        },
        options: {
          responiveAnimationDuration: 100,
          text: obj.question,
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true
              }
            }]
          }
        }
      });

      if(is_end_of_scroll) {
        $('#chat_list_scroll').animate({scrollTop: ctx.position().top}, 'slow');
      }
      else {
        if($('#chat_scroll_button').css('visibility') == 'hidden') {
          toBeScrolledPosition(ctx.position().top);
          $('#chat_scroll_button').css('visibility', 'visible');
        }
      }
    }

    function scrollDownToLastest() {
      $('#chat_list_scroll').animate({scrollTop: toBeScrolledPosition()}, 'slow');
      $('#chat_scroll_button').css('visibility', 'hidden');
    }

    function newNotice(obj) {
      // debug: get with websocket.
      //obj = {time: '2013.01.05. 13:32', description: 'notice description. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.'};

      var preappended_elem = $('#shown-notice').find('div.notice-with-time').detach();
      if(preappended_elem.length !== 0) {
        preappended_elem.prependTo('#hidden-notice');
      }

      $('#shown-notice').append('\
              <div class="notice-with-time">\
                <p class="card-text" style="margin-bottom: 0px;">' + obj.description + '</p>\
                <p class="card-text text-muted" style="text-align:right;">' + obj.time + '</p>\
              </div>');
    }

    function setRoomTitle(str) {
      $('#room_title').text(str);
      $('#head_title').text(str + ' :: coding-night-live');
    }

    function setUserCount(cnt) {
      $('#user_count').text(cnt);
    }

    </script>

    {% for notice in notices %}
    <script type="text/javascript">
      newNotice({time: "{{ notice.time }}", description: "{{ notice.description }}"});
    </script>
    {% endfor %}

    {% for chat in chats %}
    <script type="text/javascript">
      newChat({hash_value: "{{ chat.hash_value }}", time: "{{ chat.time }}", description: "{{ chat.description }}", is_reply: false});
    </script>
    {% endfor %}

    {% for reply in replys %}
    <script type="text/javascript">
      newChat({hash_value: "{{ reply.assist_hash }}", time: "{{ reply.time }}", description: "{{ reply.description }}", is_reply: true});
    </script>
    {% endfor %}

  </body>
</html>
