<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title id="head_title"></title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.1/css/drawer.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/css/tether.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js" integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/iScroll/5.1.3/iscroll.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.1/js/drawer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.2.2/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js"></script>

    {% load staticfiles %}
    <script src="{% static "js/reconnecting-websocket.min.js" %}" type="text/javascript"></script>
    <script src="{% static "js/diff_match_patch.min.js" %}" type="text/javascript"></script>

  </head>
  <style>
  .CodeMirror {
    height: auto;
  }
  .halves {
    width:50%;
    display:inline-block;
    vertical-align: top;
    border-color: #eee;
    border-width: thin;
    border-style:solid;
  }
  </style>

  <!-- connecting websocket -->
  {% load static %}
  <script src="{% static "js/cnl_websocket.js" %}" type="text/javascript"></script>

  <body class="drawer drawer--left" style="background-color:#eee">
    <!-- Slide delete modal -->
    <div class="modal fade" id="delete_slide_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Are you sure to delete this slide?</h4>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal" onclick="cnl_slides.delSlide()">Delete slide</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Slide rename modal -->
    <div class="modal fade" id="rename_slide_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <div class="input-group">
              <input id="slide_name_input" type="text" class="form-control form-control-lg" placeholder="unnamed slide">
            </div>
          </div>
          <div class="modal-footer">
            <!--<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="cnl_slides.renameSlide()">Save</button>-->
            <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="cnl_slides.getRenameSlide()">Save</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Room rename modal -->
    <div class="modal fade" id="rename_room_modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <div class="input-group">
              <input id="room_name_input" type="text" class="form-control form-control-lg">
            </div>
          </div>
          <div class="modal-footer">
            <!--<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="renameRoom()">Save</button>-->
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="rename_title_room">Save</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-light bg-faded" style="background-color:#151515; font-size:1.5em;">
      <a class="btn drawer-toggle" id="getList">
        <i class="fa fa-bars" aria-hidden="true" style="color:white"></i>
      </a>

      <!-- Navbar: Title -->
      <h3 id="room_title" class="navbar-text" style="color:white">{{ title }}</h3>
      <i class="fa fa-pencil" style="display:inline-block; cursor:pointer; color:white;" aria-hidden="true" data-toggle="modal" data-target="#rename_room_modal"></i>
      <a href="#" style="padding-left:20px;"><i class="fa fa-link" aria-hidden="true" style="color:#7b7b7b"></i></a>
      <a href="#"><i class="fa fa-download" aria-hidden="true" style="color:#7b7b7b"></i></a>

      <!-- Navbar: People count -->
      <h3 class="navbar-text float-xs-right" style="color:#1e2ea5">
        <i class="fa fa-user-plus" aria-hidden="true"></i>
        <div id="user_count" style="float:right; margin-left:10px;">34</div>
      </h3>

    </nav>

    <!-- Drawer -->
    <nav class="drawer-nav" role="navigation" style="z-index:5">

      <!-- Drawer: Slide list: Title -->
      <div class="list-group-item"><h4 class="list-group-item-heading">Contents</h4></div>

      <!-- Drawer: Slide list -->
      <ul id="slide_list" class="drawer-menu list-group">
        <!-- Drawer: Slide list: Contents -->
        {% for slide in slides %}
          <li id="slide_{{ slide.1 }}"  class="list-group-item drawer-menu-item" onclick="cnl_slides.getSlideIndex({{ slide.1 }})">{{ slide.0 }}</li>
        {% endfor %}

        <!-- Drawer: "Add" button -->
        <button class="btn btn-secondary btn-block" style="border-style:none; padding:1em;" onclick="cnl_send.newSlide()"><i class="fa fa-plus" aria-hidden="true"></i></button>
      </ul>
    </nav>

    <!-- Contents -->
    <div class="container-fluid" style="z-index:4">

      <!-- Poll prompt(to be appended here when prompted) -->
      <div id="polls-wrapper" class="row" style="padding:0px 50px">
      </div>

      <!-- Shown Contents (without poll) -->
      <div id="contents-wrapper" class="row">

        <!-- Left Div -->
        <div class="col-md-8">

          <!-- Left Div: Slide title -->
          <div class="card" style="margin-top: 1em">
            <h4 class="card-title" style="margin-top:0.5em; margin-left:0.5em;">
              <span id="markdown_title">(empty)</span>
              <i class="fa fa-pencil" style="display:inline-block; cursor:pointer;" aria-hidden="true" data-toggle="modal" data-target="#rename_slide_modal"></i>
            <i class="fa fa-trash" aria-hidden="true" style="cursor:pointer; float:right; margin-right:0.5em;" data-toggle="modal" data-target="#delete_slide_modal"></i>
            </h4>

            <!-- Left Div: Slide title: delete button -->
          </div>

          <!-- Left Div: markdown & rendered output -->
          <div style="margin-top:1em; background-color:#eee">
            <div class="halves"><textarea id="code"></textarea>
            </div><div class="halves" id="out" style="padding:1em; background-color:#fff"></div>
          </div>

        </div>

        <!-- Right Div -->
        <div class="col-md-4">

          <!-- Right Div: Notice -->
          <div id="notice_card" class="card" style="margin-top:1em;">
            <div class="card-block" style="padding-bottom:10px;">

              <!-- Right Div: Notice: Notice title -->
              <h4 class="card-title"><i class="fa fa-podcast" aria-hidden="true"></i> Notice</h4>

              <!-- Right Div: Noice: Only show 1 notice -->
              <div id="shown-notice">
              </div>

              <!-- Hidden notice lists -->
              <div id="hidden-notice">
              </div>

              <!-- Toggle notice button -->
              <a onclick="toggleNotice();" class="card-text btn btn-sm btn-block"><i id="notice-toggler" class="fa fa-sort-asc" aria-hidden="true"></i></a>

            </div>
          </div>

          <!-- Chat -->
          <div class="card" style="margin-top: 1em">

            <!-- Chat title -->
            <div class="card-block" style="border-bottom:1px solid rgba(0,0,0,.125);">
              <h4 class="card-title" style="margin-bottom:0;"><i class="fa fa-comments-o" aria-hidden="true"></i> Q&A</h4>
            </div>

            <!-- Scrollable -->
            <div id="chat_list_scroll" class="list-group list-group-flush" style="overflow-y: scroll;">

              <!-- Recieved chats -->
              <div id="chat_list_items" class="list-group-item" style="border-style: none;">
              </div>
            </div>

            <!-- "New messages" button(only shown when new message came) -->
            <div id="chat_scroll_button" style="position:absolute; height:3em; text-align:center; bottom:2em; left:0px; right:0px; background-color:rgba(0, 116, 217, 0.8); padding-top:0.5em; color:#ffffff; visibility:hidden; cursor:pointer;" onclick="scrollDownToLastest()">
              New messages
            </div>

            <!-- Reply Form -->
            <form id="chat_form" method="post" action="">
              <div class="input-group" style="z-index:1">
                <input id="chat_input" type="text" class="form-control" placeholder="Type @help for syntax...">
                <span class="input-group-btn">
                  <button class="btn btn-secondary" id="send-btn" type="submit">Send</button>
                </span>
              </div>
            </form>

          </div>
        </div>
      </div>
    </div>

    <!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js" integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/iScroll/5.1.3/iscroll.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/drawer/3.2.1/js/drawer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.22.0/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.2.2/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    -->

   <script>
    $(document).ready(function() {
      // drawer init
      $('.drawer').drawer({
        class: {
          nav: 'drawer-nav',
          toggle: 'drawer-toggle'
        },
        iscroll: {
          mouseWheel: true,
          preventDefault: false,
          disableMouse: true,
          disablePointer: true,
          disableTouch: true,
        },
        showOverlay: true
      });

      // sortable init
      $('#slide_list').sortable({
        update: function(event, ui) {
          var curr_slide = ui.item;
          var next_slide = ui.item.next();
          var prev_slide = ui.item.prev();

          // below than button
          if(prev_slide.prop('tagName') == 'BUTTON') {
            curr_slide.detach().insertBefore(prev_slide);
          }

          var curr_slide_idx = parseInt(curr_slide.attr('id').split('_')[1]);
          var next_slide_idx = 0;

          if(next_slide.length === 1 && typeof next_slide.attr('id') != 'undefined' && next_slide.attr('id').substring(0,6) === 'slide_') {
            next_slide_idx = parseInt(next_slide.attr('id').split('_')[1]);
          }

          //cnl_slides.changeSlideOrder(curr_slide_idx, next_slide_idx);
          cnl_slides.getChangeSlideOrder(curr_slide_idx, next_slide_idx);
        }
      });

      // rename slide modal init
      $('#rename_slide_modal').on('show.bs.modal', function(e) {
        $('#slide_name_input').val($('#markdown_title').text());
      });

      // rename room modal init
      $('#rename_room_modal').on('show.bs.modal', function(e) {
        $('#room_name_input').val($('#room_title').text());
      });
      $('#room_name_input').attr('placeholder', window.location.pathname.replace(/^\/+|\/+$/g, '')); // default value

      // chat list size init
      chatListResize();
    });

    // notice show/hide
    function toggleNotice() {
      $('#hidden-notice').slideToggle({duration:200, step:chatListResize});

      if($('#notice-toggler').hasClass('fa-sort-desc')) {
        $('#notice-toggler').removeClass('fa-sort-desc');
        $('#notice-toggler').addClass('fa-sort-asc');
      }
      else if($('#notice-toggler').hasClass('fa-sort-asc')) {
        $('#notice-toggler').removeClass('fa-sort-asc');
        $('#notice-toggler').addClass('fa-sort-desc');
      }
    }

    // responsive chat list
    function chatListResize() {
      var viewport_height = $(window).height();
      var start_height = $('#notice_card').height() + $('#notice_card').offset().top;
      var chat_list_height = viewport_height - start_height - 140;
      if(chat_list_height < 100) {
        chat_list_height = 100;
      }
      $('#chat_list_scroll').height(chat_list_height);
    }

    function startPoll(q_str, a_strs) {
      // debug
      q_str = "Q. How does this get toggled? Let's make this question much longer!";
      a_strs = ['Lorem ipsum dolor sit amet', 'consectetur adipiscing', 'elit', 'sed do eiusmod tempor incididunt ut labore et'];

      $('#contents-wrapper').css('visibility', 'hidden');
      var a_strs_str = '<h1 id="polls-question" class="display-4" align="center" style="margin: 50px auto; display: block; max-width: 1000px; text-align: center;">' + q_str + '</h1>'
      for(var i=0; i<a_strs.length; i+=1) {
        a_strs_str += '<button type="button" class="btn btn-secondary btn-lg btn-block" onclick="endPoll(' + i.toString() + ')">' + a_strs[i] + '</button>';
      }
      $('#polls-wrapper').append(a_strs_str);
    }

    function endPoll(ret_idx) {
      $('#polls-wrapper').empty();
      $('#contents-wrapper').css('visibility', 'visible');

      // debug: do something with ret_idx
      console.log('endPoll');
      console.log(ret_idx);
    }

    function renameRoom(name) {
      // called from modal
      //name = document.getElementById("room_name_input").value;

      if(typeof name == 'undefined') {
        var name = $('#room_name_input').val();
        if(!name) name = window.location.pathname.replace(/^\/+|\/+$/g, ''); // default value
      }
      $('#room_title').text(name);
    }


    $(window).resize(function() {
      chatListResize();
    });

    var valid_syntax = {
      help: "@help",
      notice: "@notice [<args>]",
      poll: "@poll [-t <\"title\">] <\"options\", ...>",
    };

    var valid_syntax_regex_pattern = [
      /^(\s)*@help\s*$/g,
      /^(\s)*@notice\s+.*$/g,
      /^(\s)*@poll\s+(-t\s*\"[^\"\']*\")?.*$/g,
    ];

    var help_regex = [
      /@/g, /@h/g, /@he/g,
      /@hel/g, /@help/g,
      /^(\s)*@help\s*$/g,
    ];

    var notice_regex = [
      /@/g, /@n/g, /@no/g,
      /@not/g, /@noti/g, /@notic/g,
      /@notice/g, /^(\s)*@notice\s+.*$/g,
    ];

    function validate_notice_syntax(command, matches) {
      var len = command.length,
          upper_bound = 7, // length of '@notice'
          is_valid = false,
          text = "@notice ",
          notice = "";

      if(len <= upper_bound) {
        // user is still typing the command;
        // check for partial syntax.
        is_valid = !!command.match(notice_regex[len-1]);
      } else {
        // check for full syntax
        is_valid = !!command.match(notice_regex[upper_bound]);
        // to retrieve only the notice message:
        // command.replace(/^(@notice\s*)/g, "");
        notice = command.replace(/^(@notice\s*)/g, "");
        text += notice;
      }

      if(is_valid === true) {
        matches = matches.concat([{label: valid_syntax.notice,
                                   value: text}]);
      } return matches;
    }

    function validate_help_syntax(command, matches) {
      var len = command.length,
          upper_bound = 5, // length of '@help'
          is_valid = false,
          text = "@help";

      if(len <= upper_bound) {
        // user is still typing the command;
        // check for partial syntax.
        is_valid = !!command.match(help_regex[len-1]);
      } else {
        // check for full systax
        is_valid = !!command.match(help_regex[upper_bound]);
      }
      if(is_valid === true) {
        matches = matches.concat([{label: valid_syntax.help,
                                   value: text}]);
      }
      return matches;
    }
    var poll_regex = [
      /^@$/g, /^@p$/g, /^@po$/g,
      /^@pol$/g, /^@poll$/g,
      /^@poll\s$/g,
    ];
    var poll_opt_regex = [
      /^-t\s*(?![^\"\'])/g,
      /^-(?![^t])/g,
    ];
    function validate_poll_syntax(command, matches) {
      var len = 0,
          upper_bound = 6,          // length of '@poll '
          is_valid = false,
          title_given = false,
          text = "@poll ",
          title = null,
          quotation_choice = "\"",  // either ' || "
          options = [];

      // remove leading white spaces
      command = command.replace(/^\s*/g, "");
      len = command.length;

      if(len <= upper_bound) {
        // user is still typing the command;
        // valid commands include: @, @p, @po, @pol, @poll
        if(!!command.match(poll_regex[len-1]))
          return matches = matches.concat([{label: valid_syntax.poll, value: text}]);
        else
          return matches;
      } else {
        if(!!!command.match(/^@poll\s+(?![^-\'\"])/g)) {
          // command doesn't start with '@poll '
          // or the first character after '@poll ' is invalid
          return matches;
        }
        // command starts with '@poll '
        // remove '@poll ' from the command
        command = command.replace(/^@poll\s+/g, "");
        if(command.length === 0) {
          // input command is '@poll '
          matches = matches.concat([{label: valid_syntax.poll, value: text}]);
          return matches;
        } else {
          command = command.trim();
        }

        if(!!command.match(/^-(?=[^t])/g)) {
          // check for invalid option
          return matches;
        }
        for(var i=0; i<poll_opt_regex.length; i+=1) {
          // title option is given before "","",...
          // if title given, sets title_given to true
          // console.log("[debug] checking for early title option");

          if(!!command.match(poll_opt_regex[i])) {
            title_given = true;
            command = command.replace(poll_opt_regex[i], "");
            text += "-t ";
            if(command.length === 0) {
              // input command is '@poll -t'
              text += (quotation_choice+quotation_choice);
              matches = matches.concat([{label: valid_syntax.poll, value: text}]);
              return matches;
            } else break;
          }
        }

        // console.log("[debug] checking for quotation choice");
        if(command[0] !== '"' && command[0] !== "'") {
          return matches;
        } else {
          quotation_choice = command[0];
        }

        if (title_given === true) {
          // console.log("[debug] retrieving early title");

          var finished = false;
          for(var i=1; i<command.length; i+=1) {
            if(command[i] === quotation_choice && command[i-1] !== "\\") {
              // user has finished typing title
              title = command.substring(1, i);
              title = title.trim();
              command = command.substring(i+1);
              finished = true; break;
            }
          }
          if(command.length === 0) {
            // user has given only the title
            text += quotation_choice + title + quotation_choice + " ";
            matches = matches.concat([{label: valid_syntax.poll, value: text}]);
            return matches;
          } else if(finished === false) {
            // user is in the middle of typing the title
            // delete the leading quotation mark and trim the white spaces
            command = command.substring(1);
            command = command.trim();
            text += quotation_choice+ command + quotation_choice + " ";
            matches = matches.concat([{label: valid_syntax.poll, value: text}]);
            return matches;
          } else if(finished === true) {
            // user has given the title, and there is more to come...
            text += quotation_choice + title + quotation_choice + " ";
          }
        } // end of if (title_given === true)

        // remove leading white spaces
        command = command.replace(/^\s*/g, "");
        if(command[0] !== quotation_choice)
          return matches;

        var option = "", finished = false;
        do {
          option = "", finished = false;
          for(var i=1; i<command.length; i+=1) {
            if(command[i] === quotation_choice && command[i-1] !== "\\") {
              // user has finished typing title
              option = command.substring(1, i);
              option = option.trim();
              if(option.length !== 0) options.push(option);
              command = command.substring(i+1);
              finished = true; break;
            }
          }
          if(command.length === 0) {
            // this option marks the end of user input
            for(var i=0; i<options.length; i+=1) {
              text += quotation_choice + options[i] + quotation_choice;
              if(i !== options.length-1) text += ', ';
              else if (i !== 0) text += ' ';
            }
            matches = matches.concat([{label: valid_syntax.poll, value: text}]);
            return matches;
          } else if(finished === false) {
            // user is in the middle of typing the option
            // delete the leading quotation mark and trim the white spaces
            command = command.substring(1);
            command = command.trim();
            options.push(command);
            for(var i=0; i<options.length; i+=1) {
              text += quotation_choice + options[i] + quotation_choice;
              if(i !== options.length-1) text += ', ';
            }
            matches = matches.concat([{label: valid_syntax.poll, value: text}]);
            return matches;
          } else if(finished === true) {
            // user has given the option, and there is more to come...
            command = command.replace(/^\s*/g, "");
            if(command[0] === ',') {
              command = command.replace(/^,\s*/g, "");
              if(command.length !== 0) {
                if(command[0] !== quotation_choice)
                  return matches;
              } else {
                for(var i=0; i<options.length; i+=1) {
                  text += quotation_choice + options[i] + quotation_choice;
                  text += ', ';
                } text += quotation_choice + quotation_choice;
                matches = matches.concat([{label: valid_syntax.poll, value: text}]);
                return matches;
              }
            } else if (title_given === false && command[0] === '-') {
              break;
            } else {
              return matches;
            }
          }
        } while(true);

        // if you are here, options are taken care of,
        // and user has not given the title option yet.
        // command should start with "-"
        if(!!command.match(/^-(?=[^t])/g)) {
          // check for invalid option
          return matches;
        }
        title = "";
        for(var i=0; i<poll_opt_regex.length; i+=1) {
          // title option is given after "","",...

          if(!!command.match(poll_opt_regex[i])) {
            command = command.replace(poll_opt_regex[i], "");
            text += "-t ";
            if(command.length === 0) {
              // input command is '@poll -t'
              text += (quotation_choice+quotation_choice+' ');
              for(var i=0; i<options.length; i+=1) {
                text += quotation_choice + options[i] + quotation_choice;
                if(i !== options.length-1) text += ', ';
              }
              matches = matches.concat([{label: valid_syntax.poll, value: text}]);
              return matches;
            } else break;
          }
        }
        if(command[0] !== quotation_choice)
          return matches;

        var finished = false;
        for(var i=1; i<command.length; i+=1) {
          if(command[i] === quotation_choice && command[i-1] !== "\\") {
            // user has finished typing title
            title = command.substring(1, i);
            title = title.trim();
            command = command.substring(i+1);
            finished = true; break;
          }
        }
        if(command.length === 0) {
          // user has given only the title
          text += quotation_choice + title + quotation_choice + " ";
        } else if(finished === false) {
          // user is in the middle of typing the title
          // delete the leading quotation mark and trim the white spaces
          command = command.substring(1);
          command = command.trim();
          text += quotation_choice+ command + quotation_choice + " ";
          for(var i=0; i<options.length; i+=1) {
            text += quotation_choice + options[i] + quotation_choice;
            if(i !== options.length-1) text += ', ';
          }
          matches = matches.concat([{label: valid_syntax.poll, value: text}]);
          return matches;
        } else if(finished === true) {
          // user has given the title, and there is more to come...
          text += quotation_choice + title + quotation_choice + " ";
        }
        // title and options all taken care of
        // there should be no remaining characters in command
        if(command.length !== 0)
          return matches;
      } // if(len <= upper_bound) else
      // for debugging: print title, options
      // console.log('title == ', title);
      // console.log('options == ', options);
      for(var i=0; i<options.length; i+=1) {
        text += quotation_choice + options[i] + quotation_choice;
        if(i !== options.length-1) text += ', ';
      }
      matches = matches.concat([{label: valid_syntax.poll, value: text}]);
      return matches;
    }

    $('#chat_form').submit(function (e) {
      // remove the leading white spaces
      var comment = $("#chat_input").val().replace(/^\s*/g, "");
      $('#chat_input').val('');
      e.preventDefault();
      console.log(comment);
      // debug: check send comment (whether its syntax is correct)
      // check syntax here
      // -> if correct, print the comment on console
      // -> if incorrect, print help message on console
      // var is_valid = false;
      // for(var i=0; i<valid_syntax_regex_pattern.length; i+=1) {
      //   is_valid = !!comment.match(valid_syntax_regex_pattern[i]);
      //   if(is_valid === true) {
      //     break;
      //   }
      // }
      // if(is_valid === true) {
      //   console.log(comment);
      // } else {
      //   comment = "'" + comment + "'";
      //   console.log(comment, "is not a valid command. See '@help'.");
      // }
    });

    $('#chat_input').autocomplete({
      position: {my: "left bottom", at: "left top"},
      source: function(request, response) {
        // debug: use regular expressions
        //console.log(request.term);

        // debug: return with list of dict
        // remove the leading white spaces
        var command = request.term.replace(/^\s*/g, ""),
            matches = [];
        matches = validate_help_syntax(command, matches);
        matches = validate_notice_syntax(command, matches);
        matches = validate_poll_syntax(command, matches);

        response(matches);
      },
      delay: 0,
    });

    var to_be_scrolled_position = 0;
    function toBeScrolledPosition(pos) {
      if(typeof pos != 'undefined') {
        to_be_scrolled_position = pos;
      }
      return to_be_scrolled_position;
    }

    function newPoll(obj) {
      // debug
      obj = {hash_value: 'this_is_hash_val', time: '2013.01.05. 13:32', question: 'poll description',
        answers: ['answer 1', 'answer 2', 'answer 3 - which is very long indeed!', 'ans4']};

      var is_end_of_scroll = $('#chat_list_scroll').scrollTop() === $('#chat_list_scroll')[0].scrollHeight - $('#chat_list_scroll').height();

      var ctx = $('<canvas id="poll_' + obj.hash_value + '" width="400" height="400"></canvas>');
      $('#chat_list_items').append(ctx);
      var pollChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: obj.answers,
          datasets: [{
            label: '',
            data: [13, 43, 92, 13],//data: Array.apply(null, {length: obj.answers.length}).map(function() {return 0;}),
          }],
        },
        options: {
          responiveAnimationDuration: 100,
          text: obj.question,
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true
              }
            }]
          }
        }
      });

      if(is_end_of_scroll) {
        $('#chat_list_scroll').animate({scrollTop: ctx.position().top}, 'slow');
      }
      else {
        if($('#chat_scroll_button').css('visibility') == 'hidden') {
          toBeScrolledPosition(ctx.position().top);
          $('#chat_scroll_button').css('visibility', 'visible');
        }
      }
    }

    function scrollDownToLastest() {
      $('#chat_list_scroll').animate({scrollTop: toBeScrolledPosition()}, 'slow');
      $('#chat_scroll_button').css('visibility', 'hidden');
    }

    function newNotice(obj) {
      // debug: get with websocket.
      //obj = {time: '2013.01.05. 13:32', description: 'notice description. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.'};

      var preappended_elem = $('#shown-notice').find('div.notice-with-time').detach();
      if(preappended_elem.length !== 0) {
        preappended_elem.prependTo('#hidden-notice');
      }

      $('#shown-notice').append('\
              <div class="notice-with-time">\
                <p class="card-text" style="margin-bottom: 0px;">' + obj.description + '</p>\
                <p class="card-text text-muted" style="text-align:right;">' + obj.time + '</p>\
              </div>');
    }

    function setRoomTitle(str) {
      $('#room_title').text(str);
      $('#head_title').text(str + ' :: coding-night-live');
    }

    function setUserCount(cnt) {
      $('#user_count').text(cnt);
    }

    </script>
    <script src="{% static "js/cnl_globals.js" %}" type="text/javascript"></script>
    <script src="{% static "js/cnl_slides.js" %}" type="text/javascript"></script>
    <script src="{% static "js/cnl_chats.js" %}" type="text/javascript"></script>

    <!-- if admin -->
    <script src="{% static "js/cnl_globals_override.js" %}" type="text/javascript"></script>
    <script src="{% static "js/cnl_slides_override.js" %}" type="text/javascript"></script>
    <!-- endif -->

    <!-- get list of notice, chat and reply -->
    {% for notice in notices %}
    <script type="text/javascript">
      cnl_chats.newNotice({time: "{{ notice.time }}", description: "{{ notice.description }}"});
    </script>
    {% endfor %}

    {% for chat in chats %}
    <script type="text/javascript">
      cnl_chats.newChat({hash_value: "{{ chat.hash_value }}", time: "{{ chat.time }}", description: "{{ chat.description }}", is_reply: false});
    </script>
    {% endfor %}

    {% for reply in replys %}
    <script type="text/javascript">
      cnl_chats.newChat({hash_value: "{{ reply.assist_hash }}", time: "{{ reply.time }}", description: "{{ reply.description }}", is_reply: true});
    </script>
    {% endfor %}

  </body>
</html>
